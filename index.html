<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name='apple-itunes-app' content='app-id=477927812'>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>春桃医生</title>
    <link rel="stylesheet" href="css/weui.min.css">
    <link rel="stylesheet" href="css/jquery-weui.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-2.1.4.js"></script>
    <script src="js/jquery-weui.js"></script>
</head>
<body>
<div class="weui_de">
    <div class="content" id="docone">
        <div class="content_text">
            <h3 class="weui_wecliam">注册  春桃医生</h3>
            <p class="weui_d_fa">来自于好友"<span class="patient"></span>"的推荐</p>
        </div>
        <div class="content_texts">
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__hd"><label class="weui-label">请输入手机号: </label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="number" pattern="[0-9]*" placeholder="" id="recordPhone" value="">
                    </div>
                </div>
            </div>
            <p class="lodingtext">输入手机号与推荐人自动成为好友,手机号仅用于登录</p>
            <span class="weui-agree">
                <input id="weuiAgree" type="checkbox" class="weui-agree__checkbox" onclick="checkeds();" checked>
                <span class="weui-agree__text">
                    阅读并同意<a href="agreement.html">《新用户注册协议》</a>
                    </span>
            </span>
        </div>
        <div class="downlode">
            <div class="weui-flex">
                <div class="weui-flex__item weui_fl_margin">
                    <a href="javascript:;" class="weui-btn weui-btn_primary weui_btn_back_dow openApp" data-id="doctorbtn" id="doctorbtn" onclick="sendMessageDOCTOR();">
                        <img src="images/a_1.png" alt="" width="22px" height="19px">&nbsp;&nbsp;
                        下载医生端
                    </a>
                </div>
            </div>
            <div class="weui-flex">
                <div class="weui-flex__item weui_fl_margin">
                    <a href="javascript:;" class="weui-btn weui-btn_primary weui_btn_back_dow openApp" data-id="userbtn" id="userbtn" onclick="sendMessageUSER();">
                        <img src="images/a_1.png" alt="" width="22px" height="19px">&nbsp;&nbsp;
                        下载用户端
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="weui_div"   style="display: none;">
    <div class="content">
        <div class="content_text">
            <h3 class="weui_wecliam">下载  春桃医生</h3>
        </div>
        <div class="content_texts" style="text-align: center;margin: 20px 0;">
            <img src="images/a_4.png" alt="" class="user_img">
        </div>
        <div class="downlode">
            <div class="weui-flex">
                <div class="weui-flex__item weui_fl_margin">
                    <a href="javascript:;" class="weui-btn weui-btn_primary weui_btn_back_dow openApp"  id="Adoctorbtn" onclick="sendMessageDOCTORs();">
                        <img src="images/a_1.png" alt="" width="22px" height="19px">&nbsp;&nbsp;
                        下载医生端
                    </a>
                </div>
            </div>
            <div class="weui-flex">
                <div class="weui-flex__item weui_fl_margin">
                    <a href="javascript:;" class="weui-btn weui-btn_primary weui_btn_back_dow openApp" id="Auserbtn" onclick="sendMessageUSERs();">
                        <img src="images/a_1.png" alt="" width="22px" height="19px">&nbsp;&nbsp;
                        下载用户端
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="weixin-tip">
    <p>
        <img src="images/2.png" alt="" class="imgopen">&nbsp;
    </p>
</div>
</body>
<script>
    //判断是否是微信
    $(window).on("load",function(){
        var winHeight = $(window).height();
        function is_weixin() {
            var ua = navigator.userAgent.toLowerCase();
            if (ua.match(/MicroMessenger/i) == "micromessenger") {
                return true;
            } else {
                return false;
            }
        }
        var isWeixin = is_weixin();
        if(isWeixin){
            $(".weixin-tip").css("height",winHeight);
            $(".weixin-tip").show();
        }
    })

    //获取url链接中的参数
    var getParam = function(name){
        var search = document.location.search;
        var pattern = new RegExp("[?&]"+name+"\=([^&]+)", "g");
        var matcher = pattern.exec(search);
        var items = null;
        if(null != matcher){
            try{
                items = decodeURIComponent(decodeURIComponent(matcher[1]));
            }catch(e){
                try{
                    items = decodeURIComponent(matcher[1]);
                }catch(e){
                    items = matcher[1];
                }
            }
        }
        return items;
    };


    //checkbox是否选中
    function  checkeds() {
        if($("#weuiAgree").is(":checked")==true){
            $("#doctorbtn").attr("disabled",false);
            $("#doctorbtn").css({"background-color":"#ff7700"})
            $("#userbtn").attr("disabled",false);
            $("#userbtn").css({"background-color":"#ff7700"})
            $("#userbtn").attr("onclick","sendMessageUSER();");
            $("#doctorbtn").attr("onclick","sendMessageDOCTOR();")
        }else{
            $("#doctorbtn").attr("disabled","disabled");
            $("#doctorbtn").css({"background-color":"#f1a05a"})
            $("#userbtn").attr("disabled","disabled");
            $("#userbtn").css({"background-color":"#f1a05a"})
            $('#userbtn').removeAttr('onclick');
            $('#doctorbtn').removeAttr('onclick');
        }
    }
    //获取推荐人
    var url=window.location.href;//设置或获取整个url为字符串
    //console.log(url);
    var refereesId=getParam('referees_id');
    var referees_type=getParam('referees_type');
    var referralId=getParam('referral_id');


    if(url.indexOf('referees_id')<0){//判断otp是否存在
        $(".weui_div").show();
        $(".weui_de").hide();
    }else{
        $(".weui_div").hide();
        $(".weui_de").show();
        $.ajax({
            type: 'GET',
            url: '/api/v1s1/commonly/refereesName',
            dataType: 'json',
            data: {
                "refereesId": refereesId,
                "refereesType": referees_type
            },
            success: function (data) {
                if(data.code=="OK"){
                    $(".patient").text(data.body.name);
                }else{
                    $.alert(data.message);
                }
            },
            error: function (data) {
            }
        })
    }
    //用户下载链接
//    var user='http://down.chuntaoyisheng.com/file/v1.1.0/patient-release.apk'; //线上
        var user='http://demo.chuntaoyisheng.com:10001/file/v1.0.0/patient-release.apk'; //本地服务器

    //医生下载链接
//    var doctor='http://down.chuntaoyisheng.com/file/v1.1.0/doctor-release.apk';
        var doctor='http://demo.chuntaoyisheng.com:10001/file/v1.0.0/doctor-release.apk';



    //直接下载
    //下载医生端
    function sendMessageDOCTORs() {
        if (navigator.userAgent.match(/(iPhone|iPod|iPad)/i)) {
            var href='http://itunes.apple.com/cn/app/id1214191498?mt=8';
        } else if (navigator.userAgent.match(/android/i)) {
//            var href= 'http://down.chuntaoyisheng.com/file/v1.1.0/doctor-release.apk';
            var href="http://demo.chuntaoyisheng.com:10001/file/v1.0.0/doctor-release.apk"
        }
        $("#Adoctorbtn").attr("href",href);
    }
    sendMessageDOCTORs();
    //下载用户端
    function sendMessageUSERs() {
        if (navigator.userAgent.match(/(iPhone|iPod|iPad)/i)) {
            var href='https://itunes.apple.com/cn/app/id1214194117?mt=8';
        } else if (navigator.userAgent.match(/android/i)) {
//            var href= 'http://down.chuntaoyisheng.com/file/v1.1.0/patient-release.apk';
            var href= 'http://demo.chuntaoyisheng.com:10001/file/v1.0.0/patient-release.apk';
        }

        $("#Auserbtn").attr("href",href);
    }
    sendMessageUSERs();
    //直接下载



    //打开医生端（安卓，ios）
    var url=window.location.href;
    var recordPhones = $("#recordPhone").val().trim();
    //医生端
    function sendMessageDOCTOR() {
        if (navigator.userAgent.match(/(iPhone|iPod|iPad)/i)) {
//            var href= "ctDoctorIos://zhaolingling/?wangzhao="+url;
            var href="http://itunes.apple.com/cn/app/id1214191498?mt=8";
            var client=$("#doctorbtn").data("id");
            var ios='http://itunes.apple.com/cn/app/id1214191498?mt=8';
            var recordPhones = $("#recordPhone").val().trim();
            console.log(recordPhones);
            var tell=/^1(3|4|5|7|8)\d{9}$/;
            if(!recordPhones){
                $.alert("请输入手机号码");
                e = window.event || e;
                e.preventDefault();
                return;
            }else if(!tell.test(recordPhones)){
                $.alert("请输入正确的手机号码！");
                e = window.event || e;
                e.preventDefault();
                return;
            }else{
                $("#doctorbtn").attr("href",href);
                $.ajax({
                    type: 'POST',
                    url: '/api/v1s1/commonly/relRecord',
                    contentType:"application/json",
                    dataType: 'json',
                    data: JSON.stringify({
                        "recordPhone":recordPhones,
                        "refereesId": refereesId,
                        "referralId": referralId
                    }),
                    success: function (data) {

                    },
                    error: function (data) {
                        $.alert(data.message);
                    }
                })
            }
        } else if (navigator.userAgent.match(/android/i)) {
            var href= "wanglangzh://zhaolinglingwl/?wangzhao="+url;
            $("#"+client).attr("href",href);
            sendMessage(doctor,href,client,ios);
        }

    }
    //用户端
    function sendMessageUSER() {
        if (navigator.userAgent.match(/(iPhone|iPod|iPad)/i)) {
//            var href= "ctUserIos://zhaolingling/?wangzhao="+url;
            var href="https://itunes.apple.com/cn/app/id1214194117?mt=8";
            var client=$("#userbtn").data("id");
            var ios='https://itunes.apple.com/cn/app/id1214194117?mt=8';
            var recordPhones = $("#recordPhone").val().trim();
            var tell=/^1(3|4|5|7|8)\d{9}$/;
            if(!recordPhones){
                $.alert("请输入手机号码");
                e = window.event || e;
                e.preventDefault();
                return;
            }else if(!tell.test(recordPhones)){
                $.alert("请输入正确的手机号码！");
                e = window.event || e;
                e.preventDefault();
                return;
            }else{
                $("#userbtn").attr("href",href);
                $.ajax({
                    type: 'POST',
                    url: '/api/v1s1/commonly/relRecord',
                    contentType:"application/json",
                    dataType: 'json',
                    data: JSON.stringify({
                        "recordPhone":recordPhones,
                        "refereesId": refereesId,
                        "referralId": referralId
                    }),
                    success: function (data) {

                    },
                    error: function (data) {
                        $.alert(data.message);
                    }
                })
            }
        } else if (navigator.userAgent.match(/android/i)) {
            var href= "wanglangzhp://zhaolingling/?wangzhao="+url;
            sendMessage(user,href,client,ios);
            $("#"+client).attr("href",href);
        }

    }
    //获取手机
    function sendMessage(download,href,client,ios){
        var recordPhone = $("#recordPhone").val().trim();
        var refereesId=getParam('referees_id');
        var referralId=getParam('referral_id');
        var tell=/^1(3|4|5|7|8)\d{9}$/;
        if(!recordPhone){
            $.alert("请输入手机号码");
            e = window.event || e;
            e.preventDefault();
            return;
        }else if(!tell.test(recordPhone)){
            $.alert("请输入正确的手机号码！");
            e = window.event || e;
            e.preventDefault();
            return;
        }else{
            $.ajax({
                type:'POST',
                url:'/api/v1s1/commonly/relRecord',
                dataType:'json',
                contentType:"application/json",
                data:JSON.stringify({
                    'recordPhone':recordPhone,
                    'refereesId':refereesId,
                    'referralId':referralId
                }),
                success:function (obj) {
                    if(obj.code=="OK"){
//                        alert($("#"+client).attr("href"));
                        openclient(download,href,client,ios);
                    }
                },
                error:function (data) {
                    $.alert(data.message);
                }
            })
        }
    }

    //打开春桃医生用户端
    var ua = navigator.userAgent.toLowerCase();
    var t;
    var url=window.location.href;
    var config = {
        /*scheme:必须*/
        scheme_IOS: "ctDoctorIos://zhaolingling/?wangzhao="+url,
        scheme_IOS:"https://itunes.apple.com/cn/app/id1214194117?mt=8",
        scheme_Adr: "wanglangzh://zhaolinglingwl/?wangzhao=="+url,
        download_url:'http://down.chuntaoyisheng.com/file/v1.1.0/patient-release.apk',
        timeout: 600
    };
    function openclient(obj,scheme,client,ios) {
        var url=window.location.href;
        var schemeUrl = "wanglangzh://zhaolinglingwl/?wangzhao="+url;
        if (navigator.userAgent.match(/(iPhone|iPod|iPad)/i)) {
            var href=scheme;
            window.location=href;
            var loadDateTime = new Date();
            window.setTimeout(function() {
                var timeOutDateTime = new Date();
                if (timeOutDateTime - loadDateTime < 5000) {
                    window.location = ios;//ios下载地址
                } else {
                    window.close();
                }
            },250);


        } else if (navigator.userAgent.match(/android/i)) {
            var href=scheme;
            $("#"+client).attr("href",href);
            var startTime = Date.now();

            var ifr = document.createElement('iframe');

            ifr.src=scheme;
            ifr.style.display = 'none';
            document.body.appendChild(ifr);

            var t = setTimeout(function() {
                var endTime = Date.now();

                if (!startTime || endTime - startTime < config.timeout + 200) {
                    window.location=obj;
                } else {

                }
            }, config.timeout);
        }


        window.onblur = function() {
            clearTimeout(t);
        }
    }
    //打开春桃医生用户端
</script>
</html>